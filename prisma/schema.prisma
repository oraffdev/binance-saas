// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// Adicione este Enum para travar os timeframes permitidos
enum Timeframe {
  M15 // 15 minutos
  H1 // 1 hora
  H4 // 4 horas
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  apiKey    String
  apiSecret String
  isActive  Boolean @default(true)

  bots      Bot[]    @relation("UserBots") // Um usuário tem muitos bots
  createdAt DateTime @default(now())
}

model Bot {
  id        String    @id @default(uuid())
  name      String // Ex: "Estratégia Agressiva XRP"
  symbol    String // Ex: "XRP/USDT"
  timeframe Timeframe // Ex: M15, H1

  amount Float @default(1) // Quanto apostar em USDT
  tp     Float @default(0) // Take Profit (ex: 0.015 para 1.5%) - Opcional
  sl     Float @default(0) // Stop Loss (ex: 0.01 para 1%) - Opcional

  // --- Configs de Saída Dinâmica (ATR) ---
  useDynamicSLTP Boolean @default(false)
  atrMultiplier  Float? // Ex: 2 (SL = 2 * ATR)
  tpSlRatio      Float? // Ex: 1.5 (TP = 1.5 * SL)

  isActive Boolean @default(true)

  autoTune         Boolean   @default(false) // Usuário quer otimização automática?
  lastTunedAt      DateTime? // Quando foi a última vez que otimizamos?
  tuneLookbackDays Int       @default(15)

  userId String
  user   User   @relation("UserBots", fields: [userId], references: [id])

  trades Trade[] @relation("BotTrades") // Um bot faz muitos trades
}

model Trade {
  id    String @id @default(uuid())
  botId String
  bot   Bot    @relation("BotTrades", fields: [botId], references: [id])

  symbol     String
  status     String // OPEN, CLOSED
  side       String // BUY_LONG, SELL_SHORT
  amount     Float
  entryPrice Float
  exitPrice  Float?
  pnl        Float?
  exitReason String?

  createdAt DateTime  @default(now())
  closedAt  DateTime?
}
